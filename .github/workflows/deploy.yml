name: Sync Nockup toolchains

on:
  push:
    branches:
      - master
    paths:
      - 'scripts/**'
      - '.github/workflows/deploy.yml'
      - 'toolchains/**'
  workflow_dispatch:
  schedule:
    - cron: '0 06 * * *' # daily at 06:00 UTC

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    env:
      NOCKCHAIN_OWNER: sigilante
      NOCKCHAIN_REPO: nockchain
      MANIFEST_DIR: toolchains
      GIT_USER_NAME: github-actions[bot]
      GIT_USER_EMAIL: github-actions[bot]@users.noreply.github.com

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get latest nockchain commit and release info
        id: nockchain_info
        run: |
          # Get latest commit
          LATEST_COMMIT=$(git ls-remote https://github.com/${{ env.NOCKCHAIN_OWNER }}/${{ env.NOCKCHAIN_REPO }}.git HEAD | cut -f1)
          LATEST_SHORT=$(echo $LATEST_COMMIT | cut -c1-7)
          
          # Get latest release tag (if any)
          LATEST_TAG=$(git ls-remote --tags https://github.com/${{ env.NOCKCHAIN_OWNER }}/${{ env.NOCKCHAIN_REPO }}.git | tail -1 | cut -d/ -f3 || echo "")
          
          echo "commit=$LATEST_COMMIT" >> $GITHUB_OUTPUT
          echo "short=$LATEST_SHORT" >> $GITHUB_OUTPUT
          echo "tag=$LATEST_TAG" >> $GITHUB_OUTPUT
          echo "Latest nockchain commit: $LATEST_COMMIT"

      - name: Make generate script executable
        run: chmod +x ./scripts/generate-manifest.sh

      - name: Generate manifests for all binaries and platforms
        run: |
          # Export the commit hash for the script to use
          export NOCKCHAIN_COMMIT="${{ steps.nockchain_info.outputs.commit }}"
          export NOCKCHAIN_SHORT="${{ steps.nockchain_info.outputs.short }}"
          
          # Define binaries and platforms
          BINARIES=("hoon" "hoonc" "nockup")
          PLATFORMS=("linux64" "darwin64")
          
          # Generate manifest for each combination
          for binary in "${BINARIES[@]}"; do
            for platform in "${PLATFORMS[@]}"; do
              echo "Generating manifest for $binary on $platform with commit $NOCKCHAIN_COMMIT"
              bash ./scripts/generate-manifest.sh "$binary" "$platform"
            done
          done

      - name: Commit and push changes if any
        run: |
          git config user.name "${GIT_USER_NAME}"
          git config user.email "${GIT_USER_EMAIL}"
          if [ -n "$(git status --porcelain)" ]; then
            git add "${MANIFEST_DIR}"
            COMMIT_MSG="chore(manifests): sync Nockup binaries from ${NOCKCHAIN_OWNER}/${NOCKCHAIN_REPO} @ ${{ steps.nockchain_info.outputs.short }}"
            git commit -m "$COMMIT_MSG"
            git push origin HEAD
          else
            echo "No changes to commit."
          fi