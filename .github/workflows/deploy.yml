name: Sync Nockup toolchains

on:
  push:
    branches:
      - master
    paths:
      - 'scripts/**'
      - '.github/workflows/deploy.yml'
      - 'toolchains/**'
  workflow_dispatch:
  schedule:
    - cron: '0 06 * * *' # daily at 06:00 UTC

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    env:
      NOCKCHAIN_OWNER: sigilante
      NOCKCHAIN_REPO: nockchain
      MANIFEST_DIR: toolchains
      GIT_USER_NAME: github-actions[bot]
      GIT_USER_EMAIL: github-actions[bot]@users.noreply.github.com

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout upstream nockchain (for tags/commits)
        uses: actions/checkout@v4
        with:
          repository: ${{ env.NOCKCHAIN_OWNER }}/${{ env.NOCKCHAIN_REPO }}
          path: upstream_nockchain
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Get latest nockchain commit
        id: latest_commit
        run: |
          cd upstream_nockchain
          LATEST_COMMIT=$(git rev-parse HEAD)
          LATEST_SHORT=$(git rev-parse --short HEAD)
          echo "commit=$LATEST_COMMIT" >> $GITHUB_OUTPUT
          echo "short=$LATEST_SHORT" >> $GITHUB_OUTPUT
          echo "Latest nockchain commit: $LATEST_COMMIT"

      - name: Make generate script executable
        run: chmod +x ./scripts/generate-manifest.sh

      - name: Generate manifests for all binaries and platforms
        run: |
          # Define binaries and platforms
          BINARIES=("hoon" "hoonc" "nockup")
          PLATFORMS=("linux64" "darwin64")  # or "macos64" - check what the CI produces
          
          # Generate manifest for each combination
          for binary in "${BINARIES[@]}"; do
            for platform in "${PLATFORMS[@]}"; do
              echo "Generating manifest for $binary on $platform"
              bash ./scripts/generate-manifest.sh "$binary" "$platform"
            done
          done

      - name: Commit and push changes if any
        run: |
          git config user.name "${GIT_USER_NAME}"
          git config user.email "${GIT_USER_EMAIL}"
          if [ -n "$(git status --porcelain)" ]; then
            git add "${MANIFEST_DIR}"
            COMMIT_MSG="chore(manifests): sync Nockup binaries from ${NOCKCHAIN_OWNER}/${NOCKCHAIN_REPO}"
            if [ "${{ github.event_name }}" == "push" ]; then
              COMMIT_MSG="$COMMIT_MSG (triggered by push)"
            elif [ "${{ github.event_name }}" == "schedule" ]; then
              COMMIT_MSG="$COMMIT_MSG (daily sync)"
            else
              COMMIT_MSG="$COMMIT_MSG (manual trigger)"
            fi
            COMMIT_MSG="$COMMIT_MSG @ ${{ steps.latest_commit.outputs.short }} - $(date -u +%Y-%m-%d)"
            git commit -m "$COMMIT_MSG"
            git push origin HEAD
          else
            echo "No changes to commit."
          fi
        env:
          GIT_USER_NAME: ${{ env.GIT_USER_NAME }}
          GIT_USER_EMAIL: ${{ env.GIT_USER_EMAIL }}
          MANIFEST_DIR: ${{ env.MANIFEST_DIR }}
          NOCKCHAIN_OWNER: ${{ env.NOCKCHAIN_OWNER }}
          NOCKCHAIN_REPO: ${{ env.NOCKCHAIN_REPO }}